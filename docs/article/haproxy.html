<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>haproxy | lunasaw</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="ä¸€æš"å³å°†"æˆå‹çš„ç¨‹åºçŒ¿.å¤§ä¸‰ç”Ÿ">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/blog/assets/css/0.styles.983d7f0c.css" as="style"><link rel="preload" href="/blog/assets/js/app.4906a91a.js" as="script"><link rel="preload" href="/blog/assets/js/3.f6432f4d.js" as="script"><link rel="preload" href="/blog/assets/js/1.8572628d.js" as="script"><link rel="preload" href="/blog/assets/js/40.9e07597c.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.fe7c4e65.js"><link rel="prefetch" href="/blog/assets/js/100.bacf9d32.js"><link rel="prefetch" href="/blog/assets/js/101.764ed1d9.js"><link rel="prefetch" href="/blog/assets/js/102.88a890cd.js"><link rel="prefetch" href="/blog/assets/js/103.8fd6b629.js"><link rel="prefetch" href="/blog/assets/js/104.7af812af.js"><link rel="prefetch" href="/blog/assets/js/105.09ec6a92.js"><link rel="prefetch" href="/blog/assets/js/106.54ae21c2.js"><link rel="prefetch" href="/blog/assets/js/11.4e7c79ac.js"><link rel="prefetch" href="/blog/assets/js/12.bf547cdf.js"><link rel="prefetch" href="/blog/assets/js/13.8a196244.js"><link rel="prefetch" href="/blog/assets/js/14.9b5480eb.js"><link rel="prefetch" href="/blog/assets/js/15.864e0bd0.js"><link rel="prefetch" href="/blog/assets/js/16.0ff05818.js"><link rel="prefetch" href="/blog/assets/js/17.dcb2a7fe.js"><link rel="prefetch" href="/blog/assets/js/18.feacb7ad.js"><link rel="prefetch" href="/blog/assets/js/19.749aa08e.js"><link rel="prefetch" href="/blog/assets/js/20.4b36acf0.js"><link rel="prefetch" href="/blog/assets/js/21.e1ff2fb6.js"><link rel="prefetch" href="/blog/assets/js/22.dd187a6c.js"><link rel="prefetch" href="/blog/assets/js/23.e5449f33.js"><link rel="prefetch" href="/blog/assets/js/24.4c618c2d.js"><link rel="prefetch" href="/blog/assets/js/25.3c83a4ac.js"><link rel="prefetch" href="/blog/assets/js/26.180302c3.js"><link rel="prefetch" href="/blog/assets/js/27.b69ff1fa.js"><link rel="prefetch" href="/blog/assets/js/28.ae38de13.js"><link rel="prefetch" href="/blog/assets/js/29.3e029789.js"><link rel="prefetch" href="/blog/assets/js/30.75be1216.js"><link rel="prefetch" href="/blog/assets/js/31.f0ad5a72.js"><link rel="prefetch" href="/blog/assets/js/32.af368b47.js"><link rel="prefetch" href="/blog/assets/js/33.f0ae685e.js"><link rel="prefetch" href="/blog/assets/js/34.eae8bcd2.js"><link rel="prefetch" href="/blog/assets/js/35.7d24c93a.js"><link rel="prefetch" href="/blog/assets/js/36.d4cff39d.js"><link rel="prefetch" href="/blog/assets/js/37.7eaa397a.js"><link rel="prefetch" href="/blog/assets/js/38.435f467b.js"><link rel="prefetch" href="/blog/assets/js/39.8799824d.js"><link rel="prefetch" href="/blog/assets/js/4.6eb1effd.js"><link rel="prefetch" href="/blog/assets/js/41.a91c64c4.js"><link rel="prefetch" href="/blog/assets/js/42.5c3e7bdf.js"><link rel="prefetch" href="/blog/assets/js/43.74f252e0.js"><link rel="prefetch" href="/blog/assets/js/44.133bb6e5.js"><link rel="prefetch" href="/blog/assets/js/45.e5bc79e5.js"><link rel="prefetch" href="/blog/assets/js/46.88d1f740.js"><link rel="prefetch" href="/blog/assets/js/47.74db4e77.js"><link rel="prefetch" href="/blog/assets/js/48.d3423aee.js"><link rel="prefetch" href="/blog/assets/js/49.c4414fbf.js"><link rel="prefetch" href="/blog/assets/js/5.5392455d.js"><link rel="prefetch" href="/blog/assets/js/50.f93baaa5.js"><link rel="prefetch" href="/blog/assets/js/51.4b4c7fb1.js"><link rel="prefetch" href="/blog/assets/js/52.8e5f7f11.js"><link rel="prefetch" href="/blog/assets/js/53.45cebd8f.js"><link rel="prefetch" href="/blog/assets/js/54.89cd9617.js"><link rel="prefetch" href="/blog/assets/js/55.6fd98ff2.js"><link rel="prefetch" href="/blog/assets/js/56.443dbef6.js"><link rel="prefetch" href="/blog/assets/js/57.c2c9e642.js"><link rel="prefetch" href="/blog/assets/js/58.161aad3d.js"><link rel="prefetch" href="/blog/assets/js/59.e153fa65.js"><link rel="prefetch" href="/blog/assets/js/6.4c27b5cf.js"><link rel="prefetch" href="/blog/assets/js/60.f4ef4843.js"><link rel="prefetch" href="/blog/assets/js/61.59f75fd6.js"><link rel="prefetch" href="/blog/assets/js/62.c4794345.js"><link rel="prefetch" href="/blog/assets/js/63.32f37fa0.js"><link rel="prefetch" href="/blog/assets/js/64.5e55a65d.js"><link rel="prefetch" href="/blog/assets/js/65.fd837975.js"><link rel="prefetch" href="/blog/assets/js/66.e9692c72.js"><link rel="prefetch" href="/blog/assets/js/67.c2d75fc3.js"><link rel="prefetch" href="/blog/assets/js/68.c1276826.js"><link rel="prefetch" href="/blog/assets/js/69.84c28df9.js"><link rel="prefetch" href="/blog/assets/js/7.c0004568.js"><link rel="prefetch" href="/blog/assets/js/70.93a040f2.js"><link rel="prefetch" href="/blog/assets/js/71.afe07a25.js"><link rel="prefetch" href="/blog/assets/js/72.fdc57a74.js"><link rel="prefetch" href="/blog/assets/js/73.4552d79f.js"><link rel="prefetch" href="/blog/assets/js/74.964be266.js"><link rel="prefetch" href="/blog/assets/js/75.5a88a9c8.js"><link rel="prefetch" href="/blog/assets/js/76.aa037dba.js"><link rel="prefetch" href="/blog/assets/js/77.8722dcfd.js"><link rel="prefetch" href="/blog/assets/js/78.dbba28f3.js"><link rel="prefetch" href="/blog/assets/js/79.a26ac305.js"><link rel="prefetch" href="/blog/assets/js/8.8f223f01.js"><link rel="prefetch" href="/blog/assets/js/80.5e05283f.js"><link rel="prefetch" href="/blog/assets/js/81.e0738bf4.js"><link rel="prefetch" href="/blog/assets/js/82.9811b53e.js"><link rel="prefetch" href="/blog/assets/js/83.ba0d7c22.js"><link rel="prefetch" href="/blog/assets/js/84.558825d4.js"><link rel="prefetch" href="/blog/assets/js/85.ed7fb497.js"><link rel="prefetch" href="/blog/assets/js/86.7e75b705.js"><link rel="prefetch" href="/blog/assets/js/87.4a17672e.js"><link rel="prefetch" href="/blog/assets/js/88.456049f0.js"><link rel="prefetch" href="/blog/assets/js/89.990a990c.js"><link rel="prefetch" href="/blog/assets/js/9.bc0b7c0d.js"><link rel="prefetch" href="/blog/assets/js/90.96c10fd9.js"><link rel="prefetch" href="/blog/assets/js/91.d8bc6965.js"><link rel="prefetch" href="/blog/assets/js/92.647fcb78.js"><link rel="prefetch" href="/blog/assets/js/93.c5a9ab33.js"><link rel="prefetch" href="/blog/assets/js/94.ad2af105.js"><link rel="prefetch" href="/blog/assets/js/95.f79765f0.js"><link rel="prefetch" href="/blog/assets/js/96.edda51aa.js"><link rel="prefetch" href="/blog/assets/js/97.f6085280.js"><link rel="prefetch" href="/blog/assets/js/98.3251afed.js"><link rel="prefetch" href="/blog/assets/js/99.59fd5d00.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.983d7f0c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-2d5f533b><div data-v-2d5f533b><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-2d5f533b data-v-2d5f533b><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-2d5f533b data-v-2d5f533b><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>lunasaw</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>luna</span>
          Â Â 
          <!---->
          2021
        </a></span></div></div> <div class="hide" data-v-2d5f533b><header class="navbar" data-v-2d5f533b><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/avatar.png" alt="lunasaw" class="logo"> <span class="site-name">lunasaw</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/basic-component/" class="nav-link"><i class="iconfont undefined"></i>
  basic-component
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/docker/" class="nav-link"><i class="iconfont undefined"></i>
  docker
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/java/" class="nav-link"><i class="iconfont undefined"></i>
  java
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/apache/" class="nav-link"><i class="iconfont undefined"></i>
  apache
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/genesis/" class="nav-link"><i class="iconfont undefined"></i>
  genesis
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/git/" class="nav-link"><i class="iconfont undefined"></i>
  git
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/http/" class="nav-link"><i class="iconfont undefined"></i>
  http
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/idea/" class="nav-link"><i class="iconfont undefined"></i>
  idea
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/javacv/" class="nav-link"><i class="iconfont undefined"></i>
  javacv
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/system/" class="nav-link"><i class="iconfont undefined"></i>
  system
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/linux/" class="nav-link"><i class="iconfont undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/project/" class="nav-link"><i class="iconfont undefined"></i>
  project
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/luna/" class="nav-link"><i class="iconfont undefined"></i>
  luna
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/mysql/" class="nav-link"><i class="iconfont undefined"></i>
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/python/" class="nav-link"><i class="iconfont undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/middle-component/" class="nav-link"><i class="iconfont undefined"></i>
  middle-component
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/rabbitmq/" class="nav-link"><i class="iconfont undefined"></i>
  rabbitmq
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/spring/" class="nav-link"><i class="iconfont undefined"></i>
  spring
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/basic-language/" class="nav-link"><i class="iconfont undefined"></i>
  basic-language
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/shiro/" class="nav-link"><i class="iconfont undefined"></i>
  shiro
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/ssh/" class="nav-link"><i class="iconfont undefined"></i>
  ssh
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vim/" class="nav-link"><i class="iconfont undefined"></i>
  vim
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vnc/" class="nav-link"><i class="iconfont undefined"></i>
  vnc
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vue/" class="nav-link"><i class="iconfont undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/json/" class="nav-link"><i class="iconfont undefined"></i>
  json
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/macos/" class="nav-link"><i class="iconfont undefined"></i>
  macos
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/frp/" class="nav-link"><i class="iconfont undefined"></i>
  frp
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/kaili/" class="nav-link"><i class="iconfont undefined"></i>
  kaili
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/maven/" class="nav-link"><i class="iconfont undefined"></i>
  maven
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/mybatis/" class="nav-link"><i class="iconfont undefined"></i>
  mybatis
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/nginx/" class="nav-link"><i class="iconfont undefined"></i>
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/redis/" class="nav-link"><i class="iconfont undefined"></i>
  redis
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/tomcat/" class="nav-link"><i class="iconfont undefined"></i>
  tomcat
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/ubuntu/" class="nav-link"><i class="iconfont undefined"></i>
  ubuntu
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/haproxy/" class="nav-link"><i class="iconfont undefined"></i>
  haproxy
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/javabin/" class="nav-link"><i class="iconfont undefined"></i>
  javabin
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-2d5f533b></div> <aside class="sidebar" data-v-2d5f533b><div class="personal-info-wrapper" data-v-ca798c94 data-v-2d5f533b><img src="/blog/avatar.png" alt="author-avatar" class="personal-img" data-v-ca798c94> <h3 class="name" data-v-ca798c94>
    luna
  </h3> <div class="num" data-v-ca798c94><div data-v-ca798c94><h3 data-v-ca798c94>95</h3> <h6 data-v-ca798c94>Article</h6></div> <div data-v-ca798c94><h3 data-v-ca798c94>48</h3> <h6 data-v-ca798c94>Tag</h6></div></div> <hr data-v-ca798c94></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/categories/basic-component/" class="nav-link"><i class="iconfont undefined"></i>
  basic-component
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/docker/" class="nav-link"><i class="iconfont undefined"></i>
  docker
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/java/" class="nav-link"><i class="iconfont undefined"></i>
  java
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/apache/" class="nav-link"><i class="iconfont undefined"></i>
  apache
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/genesis/" class="nav-link"><i class="iconfont undefined"></i>
  genesis
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/git/" class="nav-link"><i class="iconfont undefined"></i>
  git
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/http/" class="nav-link"><i class="iconfont undefined"></i>
  http
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/idea/" class="nav-link"><i class="iconfont undefined"></i>
  idea
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/javacv/" class="nav-link"><i class="iconfont undefined"></i>
  javacv
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/system/" class="nav-link"><i class="iconfont undefined"></i>
  system
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/linux/" class="nav-link"><i class="iconfont undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/project/" class="nav-link"><i class="iconfont undefined"></i>
  project
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/luna/" class="nav-link"><i class="iconfont undefined"></i>
  luna
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/mysql/" class="nav-link"><i class="iconfont undefined"></i>
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/python/" class="nav-link"><i class="iconfont undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/middle-component/" class="nav-link"><i class="iconfont undefined"></i>
  middle-component
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/rabbitmq/" class="nav-link"><i class="iconfont undefined"></i>
  rabbitmq
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/spring/" class="nav-link"><i class="iconfont undefined"></i>
  spring
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/basic-language/" class="nav-link"><i class="iconfont undefined"></i>
  basic-language
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/shiro/" class="nav-link"><i class="iconfont undefined"></i>
  shiro
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/ssh/" class="nav-link"><i class="iconfont undefined"></i>
  ssh
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vim/" class="nav-link"><i class="iconfont undefined"></i>
  vim
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vnc/" class="nav-link"><i class="iconfont undefined"></i>
  vnc
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/vue/" class="nav-link"><i class="iconfont undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/json/" class="nav-link"><i class="iconfont undefined"></i>
  json
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/macos/" class="nav-link"><i class="iconfont undefined"></i>
  macos
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/frp/" class="nav-link"><i class="iconfont undefined"></i>
  frp
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/kaili/" class="nav-link"><i class="iconfont undefined"></i>
  kaili
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/maven/" class="nav-link"><i class="iconfont undefined"></i>
  maven
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/mybatis/" class="nav-link"><i class="iconfont undefined"></i>
  mybatis
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/nginx/" class="nav-link"><i class="iconfont undefined"></i>
  nginx
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/redis/" class="nav-link"><i class="iconfont undefined"></i>
  redis
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/tomcat/" class="nav-link"><i class="iconfont undefined"></i>
  tomcat
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/ubuntu/" class="nav-link"><i class="iconfont undefined"></i>
  ubuntu
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/haproxy/" class="nav-link"><i class="iconfont undefined"></i>
  haproxy
</a></li><li class="dropdown-item"><!----> <a href="/blog/categories/javabin/" class="nav-link"><i class="iconfont undefined"></i>
  javabin
</a></li></ul></div></div><div class="nav-item"><a href="/blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-2d5f533b><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>haproxy</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>luna</span>
          Â Â 
          <!---->
          2021
        </a></span></div></div> <div data-v-2d5f533b><main class="page" style="padding-right:0;"><div class="page-title" style="display:none;"><h1 class="title">haproxy</h1> <div data-v-3b7f5bdf><i class="iconfont reco-account" data-v-3b7f5bdf><span data-v-3b7f5bdf>luna</span></i> <i class="iconfont reco-date" data-v-3b7f5bdf><span data-v-3b7f5bdf>2021-01-15</span></i> <!----> <i class="iconfont reco-tag tags" data-v-3b7f5bdf><span class="tag-item" data-v-3b7f5bdf>haproxy</span></i></div></div> <div class="theme-reco-content content__default" style="display:none;"><h2 id="haproxy"><a href="#haproxy" class="header-anchor">#</a> HAProxy</h2> <h2 id="haproxyä»‹ç»"><a href="#haproxyä»‹ç»" class="header-anchor">#</a> HAProxyä»‹ç»</h2> <p>HAProxy: æ˜¯æ³•å›½äººWilly Tarreauå¼€å‘çš„ä¸€ä¸ªå¼€æºè½¯ä»¶ï¼Œæ˜¯ä¸€æ¬¾åº”å¯¹å®¢æˆ·ç«¯10000ä»¥ä¸Šçš„åŒæ—¶è¿æ¥çš„é«˜æ€§èƒ½çš„TCPå’Œ HTTPè´Ÿè½½å‡è¡¡å™¨ã€‚å…¶åŠŸèƒ½æ˜¯ç”¨æ¥æä¾›åŸºäºcookieçš„æŒä¹…æ€§ï¼Œ åŸºäºå†…å®¹çš„äº¤æ¢ï¼Œè¿‡è½½ä¿æŠ¤çš„é«˜çº§æµé‡ç®¡åˆ¶ï¼Œè‡ªåŠ¨æ•…éšœåˆ‡æ¢ ï¼Œä»¥æ­£åˆ™è¡¨è¾¾å¼ä¸ºåŸºç¡€çš„æ ‡é¢˜æ§åˆ¶è¿è¡Œæ—¶é—´ï¼ŒåŸºäºWebçš„æŠ¥è¡¨ï¼Œé«˜çº§æ—¥å¿—è®°å½•ä»¥å¸®åŠ©æ’é™¤æ•…â€¹@éšœçš„åº”ç”¨æˆ–ç½‘ç»œåŠå…¶ä»–åŠŸèƒ½ã€‚</p> <h2 id="ç›¸å…³æ¦‚å¿µ"><a href="#ç›¸å…³æ¦‚å¿µ" class="header-anchor">#</a> ç›¸å…³æ¦‚å¿µ</h2> <h3 id="ä»£ç†çš„ä½œç”¨"><a href="#ä»£ç†çš„ä½œç”¨" class="header-anchor">#</a> ä»£ç†çš„ä½œç”¨</h3> <ol><li>æ­£å‘ä»£ç†ï¼Œåå‘ä»£ç†</li> <li>ä»£ç†æœåŠ¡å™¨ï¼Œå¯ä»¥æä¾›ç¼“å­˜åŠŸèƒ½åŠ é€Ÿå®¢æˆ·ç«¯è®¿é—®ï¼ŒåŒæ—¶å¯ä»¥å¯¹ç¼“å­˜æ•°æ®è¿›è¡Œæœ‰æ•ˆæ€§æ£€æŸ¥</li> <li>å†…å®¹è·¯ç”±ï¼šæ ¹æ®æµé‡ä»¥åŠå†…å®¹ç±»å‹å°†è¯·æ±‚è½¬å‘è‡³ç‰¹å®šçš„æœåŠ¡å™¨</li> <li>è½¬ç å™¨ï¼šæ”¯æŒå‹ç¼©åŠŸèƒ½ï¼Œå°†æ•°æ®ä»¥å‹ç¼©å½¢å¼å‘é€ç»™å®¢æˆ·ç«¯</li></ol> <h3 id="ç¼“å­˜çš„ä½œç”¨"><a href="#ç¼“å­˜çš„ä½œç”¨" class="header-anchor">#</a> ç¼“å­˜çš„ä½œç”¨</h3> <ol><li>å‡å°‘è®¿å†—ä½™å†…å®¹ä¼ è¾“</li> <li>èŠ‚çœå¸¦å®½ï¼Œç¼“è§£ç½‘ç»œç“¶é¢ˆ</li> <li>é™ä½äº†å¯¹åŸå§‹æœåŠ¡å™¨çš„è¯·æ±‚å‹åŠ›</li> <li>é™ä½äº†ä¼ è¾“å»¶è¿Ÿ</li></ol> <h3 id="è´Ÿè½½å‡è¡¡é›†ç¾¤"><a href="#è´Ÿè½½å‡è¡¡é›†ç¾¤" class="header-anchor">#</a> è´Ÿè½½å‡è¡¡é›†ç¾¤ï¼š</h3> <p>å››å±‚ï¼š
lvs, nginx(stream)ï¼Œhaproxy(mode tcp)
ä¸ƒå±‚ï¼š
http: nginx(http, ngx_http_upstream_module), haproxy(mode http), httpd, ats, perlbal, pound...</p> <h3 id="haproxyåŠŸèƒ½"><a href="#haproxyåŠŸèƒ½" class="header-anchor">#</a> HAProxyåŠŸèƒ½</h3> <p>HAProxyæ˜¯TCP / HTTPåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå°¤å…¶é€‚åˆäºé«˜å¯ç”¨æ€§ç¯å¢ƒ
å¯ä»¥é’ˆå¯¹HTTPè¯·æ±‚æ·»åŠ cookieï¼Œè¿›è¡Œè·¯ç”±åç«¯æœåŠ¡å™¨
å¯å¹³è¡¡è´Ÿè½½è‡³åç«¯æœåŠ¡å™¨ï¼Œå¹¶æ”¯æŒæŒä¹…è¿æ¥
æ”¯æŒåŸºäºcookieè¿›è¡Œè°ƒåº¦
æ”¯æŒæ‰€æœ‰ä¸»æœåŠ¡å™¨æ•…éšœåˆ‡æ¢è‡³å¤‡ç”¨æœåŠ¡å™¨
æ”¯æŒä¸“ç”¨ç«¯å£å®ç°ç›‘æ§æœåŠ¡
æ”¯æŒä¸å½±å“ç°æœ‰è¿æ¥æƒ…å†µä¸‹åœæ­¢æ¥å—æ–°è¿æ¥è¯·æ±‚
å¯ä»¥åœ¨åŒå‘æ·»åŠ ï¼Œä¿®æ”¹æˆ–åˆ é™¤HTTPæŠ¥æ–‡é¦–éƒ¨
æ”¯æŒåŸºäºpatternå®ç°è¿æ¥è¯·æ±‚çš„è®¿é—®æ§åˆ¶
é€šè¿‡ç‰¹å®šçš„URIä¸ºæˆæƒç”¨æˆ·æä¾›è¯¦ç»†çš„çŠ¶æ€ä¿¡æ¯
ç‰ˆæœ¬ï¼š1.4 1.5 1.6 1.7 1.8
<img src="https://i.loli.net/2021/01/29/xjDWm63snTL48fG.png" alt="img"></p> <p>æ”¯æŒhttpåå‘ä»£ç†
æ”¯æŒåŠ¨æ€ç¨‹åºçš„åå‘ä»£ç†
æ”¯æŒåŸºäºæ•°æ®åº“çš„åå‘ä»£ç†</p> <h2 id="haproxyç»„æˆ"><a href="#haproxyç»„æˆ" class="header-anchor">#</a> HAproxyç»„æˆ</h2> <p>åŒ…åï¼šhaproxy</p> <h3 id="ç¨‹åºç¯å¢ƒ"><a href="#ç¨‹åºç¯å¢ƒ" class="header-anchor">#</a> ç¨‹åºç¯å¢ƒ</h3> <p>ä¸»ç¨‹åºï¼š/usr/sbin/haproxy
é…ç½®æ–‡ä»¶ï¼š/etc/haproxy/haproxy.cfg
Unit fileï¼š/usr/lib/systemd/system/haproxy.service</p> <h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="header-anchor">#</a> é…ç½®æ–‡ä»¶</h3> <p>haproxy.cfgä¸»è¦æœ‰ä¸¤éƒ¨åˆ†ç»„æˆï¼šglobalï¼Œå’Œproxiesé…ç½®æ®µ</p> <h4 id="global-å…¨å±€é…ç½®æ®µ"><a href="#global-å…¨å±€é…ç½®æ®µ" class="header-anchor">#</a> globalï¼šå…¨å±€é…ç½®æ®µ</h4> <p>è¿›ç¨‹åŠå®‰å…¨é…ç½®ç›¸å…³çš„å‚æ•°
æ€§èƒ½è°ƒæ•´ç›¸å…³å‚æ•°
Debugå‚æ•°</p> <h4 id="proxies-ä»£ç†é…ç½®æ®µ"><a href="#proxies-ä»£ç†é…ç½®æ®µ" class="header-anchor">#</a> proxiesï¼šä»£ç†é…ç½®æ®µ</h4> <p>defaultsï¼šä¸ºfrontend, backend, listenæä¾›é»˜è®¤é…ç½®
frontedï¼šå‰ç«¯ï¼Œç›¸å½“äºnginx, server {}
backendï¼šåç«¯ï¼Œç›¸å½“äºnginx, upstream {}
listenï¼šåŒæ—¶æ‹¥æœ‰å‰ç«¯å’Œåç«¯,é€‚ç”¨äºä¸€å¯¹ä¸€ç¯å¢ƒ</p> <h3 id="ç®€å•å‰ç«¯è°ƒåº¦å®ç°"><a href="#ç®€å•å‰ç«¯è°ƒåº¦å®ç°" class="header-anchor">#</a> ç®€å•å‰ç«¯è°ƒåº¦å®ç°</h3> <p>åˆ©ç”¨å››å°è™šæ‹Ÿæœºå®ç°ç®€å•çš„å‰ç«¯è½®è¯¢è°ƒåº¦ã€‚
ä¸€å°å®¢æˆ·ç«¯ï¼Œä¸€å°haproxyè°ƒåº¦å™¨ï¼Œä¸¤å°RS</p> <ol><li><p>é¦–å…ˆåœ¨åç«¯éƒ¨ç½²ä¸¤å°httpæœåŠ¡</p></li> <li><p>ç¼–è¾‘haproxyé…ç½®æ–‡ä»¶/etc/haproxy/haproxy.cfg
é»˜è®¤è®¾ç½®ä¸åšä¿®æ”¹</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@CentOS6 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/haproxy/haproxy.cfg </span>
frontend  main *:80     <span class="token comment">#è®¾ç½®ç›‘å¬ipï¼šç«¯å£</span>
default_backend         websrvs     <span class="token comment">#è°ƒç”¨åç«¯RSç»„å</span>
backend websrvs
balance     roundrobin      <span class="token comment">#è½®è¯¢ç®—æ³•</span>
server      web1 <span class="token number">192.168</span>.45.11:80 check
server      web2 <span class="token number">192.168</span>.45.12:80 check
</code></pre></div></li></ol> <h2 id="é…ç½®"><a href="#é…ç½®" class="header-anchor">#</a> é…ç½®</h2> <h3 id="globalé…ç½®å‚æ•°"><a href="#globalé…ç½®å‚æ•°" class="header-anchor">#</a> globalé…ç½®å‚æ•°ï¼š</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>global      <span class="token comment"># å…¨å±€å‚æ•°çš„è®¾ç½®</span>
log         <span class="token number">127.0</span>.0.1   local2                      
<span class="token comment"># logè¯­æ³•ï¼šlog &lt;address_1&gt;[max_level_1] </span>
<span class="token comment"># å…¨å±€çš„æ—¥å¿—é…ç½®ï¼Œä½¿ç”¨logå…³é”®å­—ï¼ŒæŒ‡å®šä½¿ç”¨127.0.0.1ä¸Šçš„syslogæœåŠ¡ä¸­çš„local0æ—¥å¿—è®¾å¤‡ï¼Œè®°å½•æ—¥å¿—ç­‰çº§ä¸ºinfoçš„æ—¥å¿—</span>
<span class="token function">chroot</span>      /var/lib/haproxy        <span class="token comment">#æ”¹å˜å½“å‰å·¥ä½œç›®å½•</span>
pidfile     /var/run/haproxy.pid    <span class="token comment">#å½“å‰è¿›ç¨‹idæ–‡ä»¶</span>
maxconn     <span class="token number">4000</span>                    <span class="token comment">#æœ€å¤§è¿æ¥æ•°</span>
user        haproxy                 <span class="token comment">#æ‰€å±ç”¨æˆ·</span>
group       haproxy                 <span class="token comment">#æ‰€å±ç»„</span>
daemon                              <span class="token comment">#ä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œhaproxy</span>
stats socket /var/lib/haproxy/stats <span class="token comment">#åŸºäºæœ¬åœ°çš„æ–‡ä»¶ä¼ è¾“</span>
</code></pre></div><p>å®ç°æ—¥å¿—è®°å½•ï¼š
haproxyé…ç½®æ–‡ä»¶ä¸­é»˜è®¤å®šä¹‰äº†log 127.0.0.1 local2 è¯´æ˜æ—¥å¿—å°†è¢«è®°å½•åœ¨æœ¬æœºçš„local2è®¾æ–½ä¸­ã€‚
ç¼–è¾‘rsyslogé…ç½®æ–‡ä»¶ï¼š</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@CentOS6 ~<span class="token punctuation">]</span><span class="token comment">#vim /etc/rsyslog.conf</span>
<span class="token comment"># Provides UDP syslog reception</span>
<span class="token variable">$ModLoad</span> imudp      <span class="token comment">#å–æ¶ˆæ³¨é‡Š</span>
<span class="token variable">$UDPServerRun</span> <span class="token number">514</span>   <span class="token comment">#å–æ¶ˆæ³¨é‡Š</span>
local2.*            /var/log/haproxy.log
<span class="token comment">#æŒ‡å®šè®¾å¤‡local2æ—¥å¿—å­˜æ”¾ä½ç½®</span>
</code></pre></div><p>haproxyçš„æ—¥å¿—ä¿¡æ¯å¯ä»¥è®¾ç½®å­˜æ”¾åœ¨ä¸“é—¨çš„æ—¥å¿—æœåŠ¡å™¨ä¸­</p> <h3 id="proxiesé…ç½®å‚æ•°"><a href="#proxiesé…ç½®å‚æ•°" class="header-anchor">#</a> proxiesé…ç½®å‚æ•°ï¼š</h3> <p>ä»£ç†é…ç½®æ®µï¼š</p> <ul><li>defaults <name></name></li> <li>frontend <name></name></li> <li>backend <name></name></li> <li>listen <name></name></li></ul> <p>Frontendæ®µï¼šæŒ‡å®šæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ä¾¦å¬å¥—æ¥å­—è®¾ç½®
Backendæ®µï¼šæŒ‡å®šå°†è¿æ¥è¯·æ±‚è½¬å‘è‡³åç«¯æœåŠ¡å™¨çš„ç›¸å…³è®¾ç½®
Listenæ®µï¼šæŒ‡å®šå®Œæ•´çš„å‰åç«¯è®¾ç½®ï¼Œåªå¯¹ TCP æœ‰æ•ˆ
proxy åç§°ï¼šä½¿ç”¨å­—æ¯ æ•°å­— - _ . : å¹¶åŒºåˆ†å­—ç¬¦å¤§å°å†™</p> <div class="language-bash extra-class"><pre class="language-bash"><code>mode        http             
<span class="token comment">#é»˜è®¤çš„æ¨¡å¼mode { tcp|http|health }ï¼Œtcpæ˜¯4å±‚ï¼Œhttpæ˜¯7å±‚ï¼Œhealthåªä¼šè¿”å›OK</span>
log         global        
<span class="token comment">#åº”ç”¨å…¨å±€çš„æ—¥å¿—é…ç½®</span>
option      httplog       
<span class="token comment"># å¯ç”¨æ—¥å¿—è®°å½•HTTPè¯·æ±‚ï¼Œé»˜è®¤haproxyæ—¥å¿—è®°å½•æ˜¯ä¸è®°å½•HTTPè¯·æ±‚æ—¥å¿—</span>
option      dontlognull   
<span class="token comment"># å¯ç”¨è¯¥é¡¹ï¼Œæ—¥å¿—ä¸­å°†ä¸ä¼šè®°å½•ç©ºè¿æ¥ã€‚æ‰€è°“ç©ºè¿æ¥å°±æ˜¯åœ¨ä¸Šæ¸¸çš„è´Ÿè½½å‡è¡¡å™¨æˆ–è€…ç›‘æ§ç³»ç»Ÿä¸ºäº†æ¢æµ‹è¯¥æœåŠ¡æ˜¯å¦å­˜æ´»å¯ç”¨æ—¶ï¼Œéœ€è¦å®šæœŸçš„è¿æ¥æˆ–è€…è·å–æŸä¸€å›ºå®šçš„ç»„ä»¶æˆ–é¡µé¢ï¼Œæˆ–è€…æ¢æµ‹æ‰«æç«¯å£æ˜¯å¦åœ¨ç›‘å¬æˆ–å¼€æ”¾ç­‰åŠ¨ä½œè¢«ç§°ä¸ºç©ºè¿æ¥ï¼›å®˜æ–¹æ–‡æ¡£ä¸­æ ‡æ³¨ï¼Œå¦‚æœè¯¥æœåŠ¡ä¸Šæ¸¸æ²¡æœ‰å…¶ä»–çš„è´Ÿè½½å‡è¡¡å™¨çš„è¯ï¼Œå»ºè®®ä¸è¦ä½¿ç”¨è¯¥å‚æ•°ï¼Œå› ä¸ºäº’è”ç½‘ä¸Šçš„æ¶æ„æ‰«ææˆ–å…¶ä»–åŠ¨ä½œå°±ä¸ä¼šè¢«è®°å½•ä¸‹æ¥</span>
option      http-server-close  
<span class="token comment">#æ¯æ¬¡è¯·æ±‚å®Œæ¯•åä¸»åŠ¨å…³é—­httpé€šé“</span>
option      forwardfor       except <span class="token number">127.0</span>.0.0/8   
<span class="token comment">#å¦‚æœæœåŠ¡å™¨ä¸Šçš„åº”ç”¨ç¨‹åºæƒ³è®°å½•å‘èµ·è¯·æ±‚çš„å®¢æˆ·ç«¯çš„IPåœ°å€ï¼Œéœ€è¦åœ¨HAProxyä¸Šé…ç½®æ­¤é€‰é¡¹ï¼Œ è¿™æ · HAProxyä¼šæŠŠå®¢æˆ·ç«¯çš„IPä¿¡æ¯å‘é€ç»™æœåŠ¡å™¨ï¼Œåœ¨HTTPè¯·æ±‚ä¸­æ·»åŠ &quot;X-Forwarded-For&quot;å­—æ®µã€‚å¯ç”¨X-Forwarded-Forï¼Œåœ¨requestså¤´éƒ¨æ’å…¥å®¢æˆ·ç«¯IPå‘é€ç»™åç«¯çš„serverï¼Œä½¿åç«¯serverè·å–åˆ°å®¢æˆ·ç«¯çš„çœŸå®IPã€‚ </span>
option        redispatch                      
<span class="token comment">#å½“ä½¿ç”¨äº†cookieæ—¶ï¼Œhaproxyå°†ä¼šå°†å…¶è¯·æ±‚çš„åç«¯æœåŠ¡å™¨çš„serverIDæ’å…¥åˆ°cookieä¸­ï¼Œä»¥ä¿è¯ä¼šè¯çš„SESSIONæŒä¹…æ€§ï¼›è€Œæ­¤æ—¶ï¼Œå¦‚æœåç«¯çš„æœåŠ¡å™¨å®•æ‰äº†ï¼Œ ä½†æ˜¯å®¢æˆ·ç«¯çš„cookieæ˜¯ä¸ä¼šåˆ·æ–°çš„ï¼Œå¦‚æœè®¾ç½®æ­¤å‚æ•°ï¼Œå°†ä¼šå°†å®¢æˆ·çš„è¯·æ±‚å¼ºåˆ¶å®šå‘åˆ°å¦å¤–ä¸€ä¸ªåç«¯serverä¸Šï¼Œä»¥ä¿è¯æœåŠ¡çš„æ­£å¸¸ã€‚</span>
retries       <span class="token number">3</span>                             
<span class="token comment"># å®šä¹‰è¿æ¥åç«¯æœåŠ¡å™¨çš„å¤±è´¥é‡è¿æ¬¡æ•°ï¼Œè¿æ¥å¤±è´¥æ¬¡æ•°è¶…è¿‡æ­¤å€¼åå°†ä¼šå°†å¯¹åº”åç«¯æœåŠ¡å™¨æ ‡è®°ä¸ºä¸å¯ç”¨</span>
<span class="token function">timeout</span> http-request    10s     <span class="token comment">#httpè¯·æ±‚è¶…æ—¶æ—¶é—´</span>
<span class="token function">timeout</span> queue           1m      <span class="token comment">#ä¸€ä¸ªè¯·æ±‚åœ¨é˜Ÿåˆ—é‡Œçš„è¶…æ—¶æ—¶é—´</span>
<span class="token function">timeout</span> connect         10s     <span class="token comment">#è¿æ¥è¶…æ—¶</span>
<span class="token function">timeout</span> client          1m      <span class="token comment">#å®¢æˆ·ç«¯è¶…æ—¶</span>
<span class="token function">timeout</span> server          1m      <span class="token comment">#æœåŠ¡å™¨ç«¯è¶…æ—¶</span>
<span class="token function">timeout</span> http-keep-alive 10s     <span class="token comment">#è®¾ç½®http-keep-aliveçš„è¶…æ—¶æ—¶é—´</span>
<span class="token function">timeout</span> check           10s     <span class="token comment">#æ£€æµ‹è¶…æ—¶</span>
maxconn                 <span class="token number">3000</span>    <span class="token comment">#æ¯ä¸ªè¿›ç¨‹å¯ç”¨çš„æœ€å¤§è¿æ¥æ•°</span>
frontend  main *:80             <span class="token comment">#ç›‘å¬åœ°å€ä¸º80</span>
acl url_static       path_beg       -i /static /images /javascript /stylesheets
acl url_static       path_end       -i .jpg .gif .png .css .js
use_backend static          <span class="token keyword">if</span> url_static
default_backend             my_webserver     
<span class="token comment">#å®šä¹‰ä¸€ä¸ªåä¸ºmy_appå‰ç«¯éƒ¨åˆ†ã€‚æ­¤å¤„å°†å¯¹åº”çš„è¯·æ±‚è½¬å‘ç»™åç«¯</span>
backend static                                       
<span class="token comment">#ä½¿ç”¨äº†é™æ€åŠ¨æ€åˆ†ç¦»ï¼ˆå¦‚æœurl_pathåŒ¹é… .jpg .gif .png .css .jsé™æ€æ–‡ä»¶åˆ™è®¿é—®æ­¤åç«¯ï¼‰</span>
balance             roundrobin                       
<span class="token comment">#è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆ#banlance roundrobin è½®è¯¢ï¼Œbalance source ä¿å­˜sessionå€¼ï¼Œæ”¯æŒstatic-rrï¼Œleastconnï¼Œfirstï¼Œuriç­‰å‚æ•°ï¼‰</span>
server              static <span class="token number">127.0</span>.0.1:80 check         
<span class="token comment">#é™æ€æ–‡ä»¶éƒ¨ç½²åœ¨æœ¬æœºï¼ˆä¹Ÿå¯ä»¥éƒ¨ç½²åœ¨å…¶ä»–æœºå™¨æˆ–è€…squidç¼“å­˜æœåŠ¡å™¨ï¼‰</span>
backend my_webserver                                 
<span class="token comment">#å®šä¹‰ä¸€ä¸ªåä¸ºmy_webserveråç«¯éƒ¨åˆ†ã€‚PSï¼šæ­¤å¤„my_webserveråªæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰åå­—è€Œå·²ï¼Œä½†æ˜¯éœ€è¦ä¸frontendé‡Œé¢é…ç½®é¡¹default_backend å€¼ç›¸ä¸€è‡´</span>
balance     roundrobin          <span class="token comment">#è´Ÿè½½å‡è¡¡ç®—æ³•</span>
server  web01 <span class="token number">172.31</span>.2.33:80  check inter <span class="token number">2000</span> fall <span class="token number">3</span> weight <span class="token number">30</span>              <span class="token comment">#å®šä¹‰çš„å¤šä¸ªåç«¯</span>
server  web02 <span class="token number">172.31</span>.2.34:80  check inter <span class="token number">2000</span> fall <span class="token number">3</span> weight <span class="token number">30</span>              <span class="token comment">#å®šä¹‰çš„å¤šä¸ªåç«¯</span>
server  web03 <span class="token number">172.31</span>.2.35:80  check inter <span class="token number">2000</span> fall <span class="token number">3</span> weight <span class="token number">30</span>              <span class="token comment">#å®šä¹‰çš„å¤šä¸ªåç«¯</span>
</code></pre></div><h3 id="balanceé…ç½®"><a href="#balanceé…ç½®" class="header-anchor">#</a> Balanceé…ç½®</h3> <p>balanceï¼šåç«¯æœåŠ¡å™¨ç»„å†…çš„æœåŠ¡å™¨è°ƒåº¦ç®—æ³•
balance <algorithm> [ <arguments> ]
balance url_param <param> [check_post]
haproxyä¸­è°ƒåº¦ç®—æ³•åŒæ ·åˆ†ä¸ºåŠ¨æ€è°ƒåº¦ç®—æ³•å’Œé™æ€è°ƒåº¦ç®—æ³•ï¼Œä¸nginxè°ƒåº¦ç®—æ³•ä¸­åŒºåˆ†åŠ¨é™æ€è°ƒåº¦ç®—æ³•çš„æ¦‚å¿µä¸åŒï¼Œnginxç”¨èƒ½ä¸èƒ½æ ¹æ®åç«¯æœåŠ¡å™¨çš„è´Ÿè½½çŠ¶å†µè¿›è¡Œè°ƒåº¦æ¥åŒºåˆ†åŠ¨é™æ€è°ƒåº¦ç®—æ³•çš„å·®åˆ«ï¼Œè€Œhaproxyä¸­åˆ™æ ¹æ®è¯¥ç®—æ³•æ”¯ä¸æ”¯æŒè¿è¡Œæ—¶å³æ—¶ç”Ÿæ•ˆæ¥åŒºåˆ†åŠ¨é™æ€ç®—æ³•ã€‚</arguments></algorithm></p> <p>è°ƒåº¦ç®—æ³•ï¼š
roundrobinï¼šåŸºäºæƒé‡è½®è¯¢ï¼ŒåŠ¨æ€ç®—æ³•ï¼Œæ”¯æŒæƒé‡çš„è¿è¡Œæ—¶è°ƒæ•´ï¼Œæ”¯æŒæ…¢å¯åŠ¨ï¼›æ¯ä¸ªåç«¯backendä¸­æœ€å¤šæ”¯æŒ4095ä¸ª
server server optionsï¼š weight #</p> <p>static-rrï¼šåŸºäºæƒé‡è½®è¯¢ï¼Œé™æ€ç®—æ³•ï¼Œä¸æ”¯æŒæƒé‡çš„è¿è¡Œæ—¶è°ƒæ•´åŠæ…¢å¯åŠ¨ï¼›åç«¯ä¸»æœºæ•°é‡æ— ä¸Šé™</p> <p>leastconnï¼šåŠ æƒæœ€å°‘è¿æ¥ï¼ŒåŠ¨æ€ç®—æ³•ï¼Œæœ€å°‘è¿æ¥çš„åç«¯æœåŠ¡å™¨ä¼˜å…ˆåˆ†é…æ¥æ”¶æ–°è¿æ¥ï¼Œç›¸åŒè¿æ¥æ—¶è½®è¯¢ï¼Œé€‚ç”¨äºé•¿è¿æ¥åœºæ™¯ï¼Œä¾‹å¦‚ MySQLã€LDAPç­‰ï¼Œä¸é€‚åˆhttp</p> <p>firstï¼šæ ¹æ®æœåŠ¡å™¨åœ¨åˆ—è¡¨ä¸­çš„ä½ç½®ï¼Œè‡ªä¸Šè€Œä¸‹è¿›è¡Œè°ƒåº¦ï¼›å‰é¢æœåŠ¡å™¨çš„è¿æ¥æ•°è¾¾åˆ°ä¸Šé™ï¼Œæ–°è¯·æ±‚æ‰ä¼šåˆ†é…ç»™ä¸‹ä¸€å°æœåŠ¡</p> <p>sourceï¼šæºåœ°å€hashï¼Œæ–°è¿æ¥å…ˆæŒ‰æƒé‡åˆ†é…ï¼Œåç»­è¿æ¥æŒ‰sourceåˆ†é…è¯·æ±‚
åŠ¨é™æ€å–å†³äºhash type
hash-typeï¼šå“ˆå¸Œç®—æ³•
hash-type <method><function><modifier>
method:
map-basedï¼šé™¤æƒå–ä½™æ³•ï¼Œå“ˆå¸Œæ•°æ®ç»“æ„æ˜¯é™æ€æ•°ç»„ï¼ˆä¸æ”¯æŒæƒé‡åŠ¨æ€è°ƒæ•´ï¼‰
consistentï¼šä¸€è‡´æ€§å“ˆå¸Œï¼Œå“ˆå¸Œæ•°æ®ç»“æ„æ˜¯ä¸€æ£µæ ‘ ï¼ˆæ”¯æŒæƒé‡åŠ¨æ€è°ƒæ•´ï¼‰
<function> : å“ˆå¸Œå‡½æ•°
sdbm djb2 wt6</function></modifier></function></method></p> <p>uriï¼š
å¯¹URIçš„å·¦åŠéƒ¨åˆ†æˆ–æ•´ä¸ªuriåšhashè®¡ç®—ï¼Œå¹¶é™¤ä»¥æœåŠ¡å™¨æ€»æƒé‡å–æ¨¡ï¼Œä»¥åæ´¾å‘è‡³æŸæŒ‘å‡ºçš„æœåŠ¡å™¨,é€‚ç”¨äºåç«¯ç¼“å­˜æœåŠ¡å™¨
åŠ¨é™æ€å–å†³äºhash type</p> <div class="language- extra-class"><pre class="language-text"><code>hash-type
    map-based
    consistent
</code></pre></div><p><scheme>ğŸ˜•/<user>:<password>@<host>:<port>/<path> ;<params>?<query>#<frag>
å·¦åŠéƒ¨åˆ†ï¼š/<path>;<params>
æ•´ä¸ªuriï¼š/<path>;<params>?<query>#<frag></frag></query></params></path></params></path></frag></query></params></path></port></host></password></user></scheme></p> <p>url_paramï¼š
å¯¹ç”¨æˆ·è¯·æ±‚çš„uriå¬<params>éƒ¨åˆ†ä¸­çš„å‚æ•°çš„å€¼ä½œhashè®¡ç®—ï¼Œ å¹¶ç”±æœåŠ¡å™¨æ€»æƒé‡ç›¸é™¤ä»¥åæ´¾å‘è‡³æŸæŒ‘å‡ºçš„æœåŠ¡å™¨ï¼›é€šå¸¸ç”¨äºè¿½è¸ªç”¨æˆ·ï¼Œä»¥ç¡®ä¿æ¥è‡ªåŒä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚å§‹ç»ˆå‘å¾€åŒä¸€ä¸ªBackend Server
åŠ¨é™æ€å–å†³äºhash type</params></p> <div class="language- extra-class"><pre class="language-text"><code>hash-type
    map-based
    consistent
</code></pre></div><p>hdr(<name>)ï¼šæ ¹æ®è¯·æ±‚æŠ¥æ–‡ä¸­æŒ‡å®šçš„headerï¼ˆå¦‚use_agent,referer,hostnameï¼‰å°†è¯¥hesderåšhashè®¡ç®—è¿›è¡Œè°ƒåº¦
åŠ¨é™æ€å–å†³äºhash type</name></p> <div class="language- extra-class"><pre class="language-text"><code>hash-type
    map-based
    consistent
</code></pre></div><p>hdr(Cookie)</p> <p>rdp-cookie è¿œç¨‹æ¡Œé¢ç›¸å…³</p> <p>rdp-cookie(<name>)</name></p> <h3 id="default-backend"><a href="#default-backend" class="header-anchor">#</a> default_backend <backend></backend></h3> <p>æ— use_backend åŒ¹é…æ—¶ï¼Œä½¿ç”¨é»˜è®¤çš„backendï¼Œç”¨äº frontendä¸­</p> <h3 id="server"><a href="#server" class="header-anchor">#</a> server</h3> <p>server <name><address>[:[port]] [param*]
å®šä¹‰åç«¯ä¸»æœºçš„å„æœåŠ¡å™¨åŠå…¶é€‰é¡¹ server <name><address>[:port] [settings ...] default-server [settings ...]</address></name></address></name></p> <p><name>ï¼šæœåŠ¡å™¨åœ¨haproxyä¸Šçš„å†…éƒ¨åç§°ï¼›å‡ºç°åœ¨æ—¥å¿—åŠè­¦å‘Šä¿¡æ¯</name></p> <address>ï¼šæœåŠ¡å™¨åœ°å€ï¼Œæ”¯æŒä½¿ç”¨ä¸»æœºå
<p>[:[port]]ï¼šç«¯å£æ˜ å°„ï¼›çœç•¥æ—¶ï¼Œè¡¨ç¤ºåŒbindä¸­ç»‘å®šçš„ç«¯å£</p> <p>[param*]ï¼šå‚æ•°
checkï¼šå¯¹å½“å‰serveråšå¥åº·çŠ¶æ€æ£€æµ‹ï¼Œåªç”¨äºå››å±‚æ£€æµ‹
æ³¨æ„ï¼šhttpchkï¼Œâ€œsmtpchkâ€, â€œmysql-checkâ€, â€œpgsql-checkâ€ and â€œsslhello-chkâ€ ç”¨äºå®šä¹‰åº”ç”¨å±‚æ£€æµ‹æ–¹æ³•
addr ï¼šæ£€æµ‹æ—¶ä½¿ç”¨çš„IPåœ°å€
port ï¼šé’ˆå¯¹æ­¤ç«¯å£è¿›è¡Œæ£€æµ‹
inter <delay>ï¼šè¿ç»­ä¸¤æ¬¡æ£€æµ‹ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤ä¸º2000ms
rise <count>ï¼šè¿ç»­å¤šå°‘æ¬¡æ£€æµ‹ç»“æœä¸ºâ€œæˆåŠŸâ€æ‰æ ‡è®°æœåŠ¡å™¨ä¸ºå¯ç”¨ ï¼›é»˜è®¤ä¸º2
fall <count>ï¼šè¿ç»­å¤šå°‘æ¬¡æ£€æµ‹ç»“æœä¸ºâ€œå¤±è´¥â€æ‰æ ‡è®°æœåŠ¡å™¨ä¸ºä¸å¯ ç”¨ï¼›é»˜è®¤ä¸º3
cookie <value>ï¼šä¸ºå½“å‰serveræŒ‡å®šcookieå€¼ï¼Œå®ç°åŸºäºcookieçš„ä¼šè¯é»æ€§
disabledï¼šæ ‡è®°ä¸ºä¸å¯ç”¨
redir <prefix>ï¼šå°†å‘å¾€æ­¤serverçš„æ‰€æœ‰GETå’ŒHEADç±»çš„è¯·æ±‚é‡å®šå‘è‡³æŒ‡ å®šçš„URL
weight <weight>ï¼šæƒé‡ï¼Œé»˜è®¤ä¸º1
maxconn <maxconn>ï¼šå½“å‰serverçš„æœ€å¤§å¹¶å‘è¿æ¥æ•°
backlog <backlog>ï¼šå½“serverçš„è¿æ¥æ•°è¾¾åˆ°ä¸Šé™åçš„åæ´é˜Ÿåˆ—é•¿åº¦
backupï¼šè®¾å®šå½“å‰serverä¸ºå¤‡ç”¨æœåŠ¡å™¨</backlog></maxconn></weight></prefix></value></count></count></delay></p> <p>default-server [param*] ä¸ºbackendä¸­çš„å„serverè®¾å®šé»˜è®¤é€‰é¡¹</p> <h3 id="bindé…ç½®"><a href="#bindé…ç½®" class="header-anchor">#</a> bindé…ç½®</h3> <p>bindï¼šæŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªå‰ç«¯ä¾¦å¬åœ°å€å’Œç«¯å£
åªç”¨äºfrountendé…ç½®æ®µå’Œlistené…ç½®æ®µ
bind [</p><address>]:&lt;port_range&gt; [, ...] [param*]
ç¤ºä¾‹ï¼š<p></p> <div class="language-bash extra-class"><pre class="language-bash"><code>listen http_proxy 
    <span class="token builtin class-name">bind</span> :80,:443 
    <span class="token builtin class-name">bind</span> <span class="token number">10.0</span>.0.1:10080,10.0.0.1:10443 
    <span class="token builtin class-name">bind</span> /var/run/ssl-frontend.sock user root mode <span class="token number">600</span> accept-proxy
</code></pre></div><h3 id="maxconn"><a href="#maxconn" class="header-anchor">#</a> maxconn</h3> <p>maxconn <conns>ï¼šä¸ºæŒ‡å®šçš„frontendå®šä¹‰å…¶æœ€å¤§å¹¶å‘è¿æ¥æ•°ï¼›é»˜è®¤ä¸º2000</conns></p> <h3 id="mode-tcp-http-health"><a href="#mode-tcp-http-health" class="header-anchor">#</a> mode { tcp|http|health }</h3> <p>å®šä¹‰haproxyçš„å·¥ä½œæ¨¡å¼
tcpï¼šåŸºäºlayer4å®ç°ä»£ç†ï¼›å¯ä»£ç†mysql, pgsql, ssh, sslç­‰åè®®,httpsæ—¶ä½¿ç”¨æ­¤æ¨¡å¼ï¼Œé»˜è®¤æ¨¡å¼
httpï¼šä»…å½“ä»£ç†åè®®ä¸ºhttpæ—¶ä½¿ç”¨,centoså®é™…é»˜è®¤æ¨¡å¼
healthï¼šå·¥ä½œä¸ºå¥åº·çŠ¶æ€æ£€æŸ¥çš„å“åº”æ¨¡å¼ï¼Œå½“è¿æ¥è¯·æ±‚åˆ°è¾¾æ—¶å›åº”â€œOKâ€åå³æ–­å¼€è¿æ¥ï¼Œè¾ƒå°‘ä½¿ç”¨</p> <h3 id="åŸºäºcookieçš„ä¼šè¯ç»‘å®š"><a href="#åŸºäºcookieçš„ä¼šè¯ç»‘å®š" class="header-anchor">#</a> åŸºäºcookieçš„ä¼šè¯ç»‘å®š</h3> <p>cookie <name> [ rewrite | insert | prefix ] [ indirect ] [ nocache ] [ postonly ] [ preserve ] [ httponly ] [ secure ] [ domain <domain> ]* [ maxidle <idle> ] [ maxlife <life> ]
<name>ï¼šcookieåç§°ï¼Œç”¨äºå®ç°æŒä¹…è¿æ¥
rewriteï¼šé‡å†™
insertï¼šæ’å…¥
prefixï¼šå‰ç¼€
é…ç½®ç¤ºä¾‹ï¼š</name></life></idle></domain></name></p> <div class="language-bash extra-class"><pre class="language-bash"><code>backend websrvs
  balance     roundrobin
  cookie WEBSRV insert nocache indirect
  server   web1 <span class="token number">192.168</span>.45.11:80 check cookie srv1
  server   web2 <span class="token number">192.168</span>.45.12:80 check cookie srv2
<span class="token comment">#æ¯ä¸ªserveræœ‰è‡ªå·±çš„å”¯ä¸€çš„cookieæ ‡è¯†</span>
<span class="token comment">#åœ¨backendä¸­ä¸ºç”¨æˆ·è¯·æ±‚è°ƒåº¦å®Œæˆåæ“çºµå…¶cookie</span>
</code></pre></div><h3 id="ç»Ÿè®¡æ¥å£å¯ç”¨ç›¸å…³çš„å‚æ•°"><a href="#ç»Ÿè®¡æ¥å£å¯ç”¨ç›¸å…³çš„å‚æ•°" class="header-anchor">#</a> ç»Ÿè®¡æ¥å£å¯ç”¨ç›¸å…³çš„å‚æ•°</h3> <p>stats enable
å¯ç”¨ç»Ÿè®¡é¡µï¼›åŸºäºé»˜è®¤çš„å‚æ•°å¯ç”¨stats page</p> <ul><li>stats uri : /haproxy?stats urié»˜è®¤å€¼</li> <li>stats realm : HAProxy Statistics</li> <li>stats auth : no authentication</li></ul> <p>stats uri <prefix> è‡ªå®šä¹‰stats page uri</prefix></p> <p>stats auth <user>:<passwd> è®¤è¯æ—¶çš„è´¦å·å’Œå¯†ç ï¼Œå¯ä½¿ç”¨å¤šæ¬¡</passwd></user></p> <p>stats realm <realm> è®¤è¯æ—¶çš„realm</realm></p> <p>stats hide-version éšè—ç‰ˆæœ¬</p> <p>stats refresh <delay> è®¾å®šè‡ªåŠ¨åˆ·æ–°æ—¶é—´é—´éš”</delay></p> <p>stats admin { if | unless } <cond> å¯ç”¨stats pageä¸­çš„ç®¡ç†åŠŸèƒ½</cond></p> <p>é…ç½®ç¤ºä¾‹ï¼š</p> <div class="language-bash extra-class"><pre class="language-bash"><code>listen stats 
    <span class="token builtin class-name">bind</span> :9099 
    stats <span class="token builtin class-name">enable</span> 
    stats realm HAPorxy<span class="token punctuation">\</span> Stats<span class="token punctuation">\</span> Page 
    stats auth ç”¨æˆ·åï¼šå¯†ç 
    stats admin <span class="token keyword">if</span> TRUE
<span class="token comment">#åœ¨frountendä¸­å•ç‹¬å®šä¹‰ä¸€ä¸ªstatsæœåŠ¡ï¼Œç›‘å¬9099ç«¯å£</span>
<span class="token comment">#å¦‚æœè®¤è¯æˆåŠŸå°±å¼€å¯ç®¡ç†åŠŸèƒ½</span>
</code></pre></div><h3 id="forwardforé…ç½®"><a href="#forwardforé…ç½®" class="header-anchor">#</a> forwardforé…ç½®</h3> <p>option forwardfor [ except <network> ] [ header <name> ] [ if-none ]
åœ¨ç”±haproxyå‘å¾€åç«¯ä¸»æœºçš„è¯·æ±‚æŠ¥æ–‡ä¸­æ·»åŠ â€œX-ForwardedForâ€é¦–éƒ¨ï¼Œå…¶å€¼ä¸ºå‰ç«¯å®¢æˆ·ç«¯çš„åœ°å€ï¼›ç”¨äºå‘åç«¯ä¸»å‘é€çœŸå®çš„å®¢æˆ·ç«¯IP</name></network></p> <p>[ except <network> ]ï¼šè¯·æ±‚æŠ¥è¯·æ¥è‡ªæ­¤å¤„æŒ‡å®šçš„ç½‘ç»œæ—¶ä¸äºˆæ·»åŠ æ­¤é¦–éƒ¨ï¼Œå¦‚haproxyè‡ªèº«æ‰€åœ¨ç½‘ç»œ</network></p> <p>[ header <name> ]ï¼šä½¿ç”¨è‡ªå®šä¹‰çš„é¦–éƒ¨åç§°ï¼Œè€Œéâ€œXForwarded-Forâ€</name></p> <p>[ if-none ] å¦‚æœæ²¡æœ‰é¦–éƒ¨æ‰æ·»åŠ é¦–éƒ¨ï¼Œå¦‚æœæœ‰ä½¿ç”¨é»˜è®¤å€¼</p> <p>ä¸ºæŒ‡å®šçš„MIMEç±»å‹å¯ç”¨å‹ç¼©ä¼ è¾“åŠŸèƒ½
compression algo <algorithm> ...ï¼šå¯ç”¨httpåè®®çš„å‹ç¼©æœºåˆ¶ï¼ŒæŒ‡æ˜å‹ç¼©ç®—æ³•gzip, deflate
compression type <mime type=""> ...ï¼šæŒ‡æ˜å‹ç¼©çš„MIMIç±»å‹</mime></algorithm></p> <h3 id="é”™è¯¯é¡µé…ç½®"><a href="#é”™è¯¯é¡µé…ç½®" class="header-anchor">#</a> é”™è¯¯é¡µé…ç½®</h3> <p>errorfile <code><file> è‡ªå®šä¹‰é”™è¯¯é¡µ
<code>ï¼šHTTP status code.
æ”¯æŒ200, 400, 403, 408, 500, 502, 503, 504.
<file>ï¼šé”™è¯¯é¡µæ–‡ä»¶è·¯å¾„</file></code></file></code></p> <p>ç¤ºä¾‹ï¼š
ä½¿ç”¨haproxyä¸»æœºæœ¬åœ°çš„æ–‡ä»¶è¿›è¡Œå“åº”</p> <div class="language-bash extra-class"><pre class="language-bash"><code>errorfile <span class="token number">400</span> /etc/haproxy/errorfiles/400badreq.http 
errorfile <span class="token number">408</span> /dev/null     <span class="token comment"># workaround Chrome preconnect bug </span>
errorfile <span class="token number">403</span> /etc/haproxy/errorfiles/403forbid.http 
errorfile <span class="token number">503</span> /etc/haproxy/errorfiles/503sorry.http 
</code></pre></div><p>ä½¿ç”¨urlè¿›è¡Œå“åº”ï¼Œå“åº”çŠ¶æ€ç ä¸º302ï¼Œä¸é€‚ç”¨äºGETä»¥å¤–çš„å…¶ä»–è¯·æ±‚æ–¹æ³•ï¼š
errorloc <code><url> ç›¸å½“äºerrorloc302 <code><url>ï¼Œåˆ©ç”¨302é‡å®šå‘è‡³æŒ‡URL</url></code></url></code></p> <div class="language- extra-class"><pre class="language-text"><code>errorloc 503 http://www.a.com/error_pages/503.html
</code></pre></div><h3 id="ä¿®æ”¹æŠ¥æ–‡é¦–éƒ¨"><a href="#ä¿®æ”¹æŠ¥æ–‡é¦–éƒ¨" class="header-anchor">#</a> ä¿®æ”¹æŠ¥æ–‡é¦–éƒ¨</h3> <p>reqadd <string> [{if | unless} <cond>]
åœ¨è¯·æ±‚æŠ¥æ–‡å°¾éƒ¨æ·»åŠ æŒ‡å®šé¦–éƒ¨</cond></string></p> <p>rspadd <string> [{if | unless} <cond>]
åœ¨å“åº”æŠ¥æ–‡å°¾éƒ¨æ·»åŠ æŒ‡å®šé¦–éƒ¨
ç¤ºä¾‹ï¼š</cond></string></p> <div class="language- extra-class"><pre class="language-text"><code>rspadd X-Via:\ HAPorxy  #å­—ç¬¦ä¸²ä¸­çš„ç©ºæ ¼è¦è½¬ä¹‰
</code></pre></div><p>reqdel <search> [{if | unless} <cond>]
reqidel <search> [{if | unless} <cond>] (ignore case) ä¸åˆ†å¤§å°å†™
ä»è¯·æ±‚æŠ¥æ–‡ä¸­åˆ é™¤åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„é¦–éƒ¨</cond></search></cond></search></p> <p>rspdel <search> [{if | unless} <cond>]
rspidel <search> [{if | unless} <cond>] (ignore case) ä¸åˆ†å¤§å°å†™ä»å“åº”æŠ¥æ–‡ä¸­åˆ é™¤åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„é¦–éƒ¨ ç¤ºä¾‹ï¼š rspidel Server.*</cond></search></cond></search></p> <h3 id="è¿æ¥è¶…æ—¶"><a href="#è¿æ¥è¶…æ—¶" class="header-anchor">#</a> è¿æ¥è¶…æ—¶</h3> <p>timeout client <timeout> å®¢æˆ·ç«¯æœ€é•¿ç©ºé—²è¿æ¥è¶…æ—¶æ—¶é•¿ é»˜è®¤å•ä½æ˜¯æ¯«ç§’
timeout server <timeout> åç«¯æœåŠ¡å™¨æœ€é•¿ç©ºé—²è¿æ¥è¶…æ—¶æ—¶é•¿
timeout http-keep-alive <timeout> æŒä¹…è¿æ¥çš„æŒä¹…æ—¶é•¿
timeout http-request <timeout> ä¸€æ¬¡å®Œæ•´çš„HTTPè¯·æ±‚çš„æœ€å¤§ç­‰å¾…æ—¶é•¿
timeout connect <timeout> æˆåŠŸè¿æ¥åç«¯æœåŠ¡å™¨çš„æœ€å¤§ç­‰å¾…æ—¶é•¿
timeout client-fin <timeout> å®¢æˆ·ç«¯åŠè¿æ¥çš„ç©ºé—²æ—¶é•¿
timeout server-fin <timeout> åç«¯æœåŠ¡å™¨åŠè¿æ¥çš„ç©ºé—²æ—¶é•¿</timeout></timeout></timeout></timeout></timeout></timeout></timeout></p> <h2 id="acl"><a href="#acl" class="header-anchor">#</a> ACL</h2> <p>aclï¼šhaproxyçš„ACLç”¨äºå®ç°åŸºäºè¯·æ±‚æŠ¥æ–‡çš„é¦–éƒ¨ã€å“åº”æŠ¥æ–‡çš„å†…å®¹æˆ–å…¶ä»–çš„ç¯å¢ƒçŠ¶æ€ä¿¡æ¯æ¥åšå‡ºè½¬å‘å†³ç­–ï¼Œè¿™å¤§å¤§å¢åŠ äº†å…¶é…ç½®å¼¹æ€§ã€‚å…¶é…ç½®æ³•åˆ™ä¸€èˆ¬åˆ†ä¸ºä¸¤éƒ¨ï¼Œé¦–å…ˆå®šä¹‰ACLï¼Œæ—¢å®šä¹‰ä¸€ä¸ªæµ‹è¯•æ¡ä»¶ï¼Œè€Œååœ¨æ¡ä»¶å¾—åˆ°æ»¡è¶³æ—¶æ‰§è¡ŒæŸç‰¹å®šåŠ¨ä½œï¼Œå¦‚é˜»æ­¢è®¿é—®æˆ–è€…è½¬å‘è‡³æŸç‰¹å®šçš„åç«¯ï¼Œ
å®šä¹‰ACLçš„è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š
acl <aclname><criterion> [flags] [operator] [<value>] ...</value></criterion></aclname></p> <p><aclname>ï¼šACLåç§°ï¼Œå¯ä½¿ç”¨å­—æ¯ æ•°å­— : . - _ åŒºåˆ†å­—ç¬¦å¤§å°å†™</aclname></p> <p><criterion>ï¼š æŒ‡æ˜æ£€æŸ¥æ¡ä»¶
å„ç§æ¡ä»¶ :
dst ç›®æ ‡IP
dst_port ç›®æ ‡PORT
src æºIP
src_port æºPORT
ç¤ºä¾‹ï¼š</criterion></p> <div class="language- extra-class"><pre class="language-text"><code>acl invalid_src src 172.16.100.200
</code></pre></div><p><value>çš„ç±»å‹ï¼š</value></p> <ul><li>boolean</li> <li>integer or integer range</li> <li>IP address / network</li> <li>string (exact, substring, suffix, prefix, subdir, domain)</li> <li>regular expression</li> <li>hex block</li></ul> <flags>
-i ä¸åŒºåˆ†å¤§å°å†™
-m ä½¿ç”¨æŒ‡å®šçš„patternåŒ¹é…æ–¹æ³•
-n ä¸åšDNSè§£æ
-u å¼ºåˆ¶æ¯ä¸ªACLå¿…é¡»å”¯ä¸€IDï¼Œå¦åˆ™å¤šä¸ªåŒåACLæˆ–å…³ç³»
-- å¼ºåˆ¶flagç»“æŸ. å½“å­—ç¬¦ä¸²å’ŒæŸä¸ªflagç›¸ä¼¼æ—¶ä½¿ç”¨
<p>[operator]
åŒ¹é…æ•´æ•°å€¼ï¼šeqã€geã€gtã€leã€lt
åŒ¹é…å­—ç¬¦ä¸²ï¼š</p> <ul><li>exact match (-m str) :å­—ç¬¦ä¸²å¿…é¡»å®Œå…¨åŒ¹é…æ¨¡å¼</li> <li>substring match (-m sub) :åœ¨æå–çš„å­—ç¬¦ä¸²ä¸­æŸ¥æ‰¾æ¨¡å¼ï¼Œ å¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªè¢«å‘ç°ï¼ŒACLå°†åŒ¹é…</li> <li>prefix match (-m beg) :åœ¨æå–çš„å­—ç¬¦ä¸²é¦–éƒ¨ä¸­æŸ¥æ‰¾æ¨¡å¼ ï¼Œå¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªè¢«å‘ç°ï¼ŒACLå°†åŒ¹é…</li> <li>suffix match (-m end) :å°†æ¨¡å¼ä¸æå–å­—ç¬¦ä¸²çš„å°¾éƒ¨è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªåŒ¹é…ï¼Œåˆ™ACLè¿›è¡ŒåŒ¹é…</li> <li>subdir match (-m dir) :æŸ¥çœ‹æå–å‡ºæ¥çš„ç”¨æ–œçº¿åˆ†éš”ï¼ˆ â€œ/â€ï¼‰çš„å­—ç¬¦ä¸²ï¼Œå¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªåŒ¹é…ï¼Œåˆ™ACLè¿›è¡ŒåŒ¹é…</li> <li>domain match (-m dom) :æŸ¥æ‰¾æå–çš„ç”¨ç‚¹ï¼ˆâ€œ.â€ï¼‰åˆ†éš” å­—ç¬¦ä¸²ï¼Œå¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªåŒ¹é…ï¼Œåˆ™ACLè¿›è¡ŒåŒ¹é…</li></ul> <h3 id="aclä½œä¸ºæ¡ä»¶æ—¶çš„é€»è¾‘å…³ç³»"><a href="#aclä½œä¸ºæ¡ä»¶æ—¶çš„é€»è¾‘å…³ç³»" class="header-anchor">#</a> aclä½œä¸ºæ¡ä»¶æ—¶çš„é€»è¾‘å…³ç³»:</h3> <ul><li>ä¸ï¼šéšå¼ï¼ˆé»˜è®¤ï¼‰ä½¿ç”¨</li> <li>æˆ–ï¼šä½¿ç”¨â€œorâ€ æˆ– â€œ||â€è¡¨ç¤º</li> <li>å¦å®šï¼šä½¿ç”¨â€œ!â€œ è¡¨ç¤º</li></ul> <p>ç¤ºä¾‹ï¼š</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">if</span> invalid_src invalid_port ä¸å…³ç³» 
<span class="token keyword">if</span> invalid_src <span class="token operator">||</span> invalid_port æˆ– 
<span class="token keyword">if</span> <span class="token operator">!</span> invalid_src é 
</code></pre></div><h3 id="base-string"><a href="#base-string" class="header-anchor">#</a> base : string</h3> <p>è¿”å›ç¬¬ä¸€ä¸ªä¸»æœºå¤´å’Œè¯·æ±‚çš„è·¯å¾„éƒ¨åˆ†çš„è¿æ¥ï¼Œè¯¥è¯·æ±‚ä»ç¬¬ä¸€ä¸ªæ–œæ å¼€å§‹ï¼Œå¹¶åœ¨é—®å·ä¹‹å‰ç»“æŸ,å¯¹è™šæ‹Ÿä¸»æœºæœ‰ç”¨
<scheme>ğŸ˜•/<user>:<password>@<host>:<port>/<path>;&lt; params&gt;?<query>#<frag>
base : exact string match
base_beg : prefix match
base_dir : subdir match
base_dom : domain match
base_end : suffix match
base_len : length match
base_reg : regex match
base_sub : substring match</frag></query></path></port></host></password></user></scheme></p> <h3 id="path-string"><a href="#path-string" class="header-anchor">#</a> path : string</h3> <p>æå–è¯·æ±‚çš„URLè·¯å¾„ï¼Œè¯¥è·¯å¾„ä»ç¬¬ä¸€ä¸ªæ–œæ å¼€å§‹ï¼Œå¹¶åœ¨é—®å·ä¹‹ å‰ç»“æŸï¼ˆæ— ä¸»æœºéƒ¨åˆ†ï¼‰
<scheme>ğŸ˜•/<user>:<password>@<host>:<port>/<path>;&lt; params&gt;?<query>#<frag>
path : exact string match
path_beg : prefix match åŒ¹é…è·¯å¾„å¼€å¤´
path_dir : subdir match
path_dom : domain match
path_end : suffix match åŒ¹é…è·¯å¾„ç»“å°¾
path_len : length match
path_reg : regex match æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ä¸€ç±»PATH
path_sub : substring match</frag></query></path></port></host></password></user></scheme></p> <h3 id="url-string"><a href="#url-string" class="header-anchor">#</a> url : string</h3> <p>æå–è¯·æ±‚ä¸­çš„URLã€‚ä¸€ä¸ªå…¸å‹çš„åº”ç”¨æ˜¯å…·æœ‰é¢„å–èƒ½åŠ›çš„ç¼“å­˜ï¼Œ ä»¥åŠéœ€è¦ä»æ•°æ®åº“èšåˆå¤šä¸ªä¿¡æ¯å¹¶å°†å®ƒä»¬ä¿å­˜åœ¨ç¼“å­˜ä¸­çš„ç½‘é¡µé—¨æˆ·å…¥å£
url : exact string match
url_beg : prefix match URLå¼€å¤´ï¼ŒåŒ¹é…åè®®
url_dir : subdir match
url_dom : domain match
url_end : suffix match URLç»“å°¾
url_len : length match
url_reg : regex match æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ä¸€ç±»url
url_sub : substring match</p> <h3 id="req-hdr"><a href="#req-hdr" class="header-anchor">#</a> req.hdr([</h3> <p>æå–åœ¨ä¸€ä¸ªHTTPè¯·æ±‚æŠ¥æ–‡çš„é¦–éƒ¨
hdr([<name>[,<occ>]]) : exact string match
hdr_beg([<name>[,<occ>]]) : prefix match é¦–éƒ¨å¼€å¤´
hdr_dir([<name>[,<occ>]]) : subdir match
hdr_dom([<name>[,<occ>]]) : domain match
hdr_end([<name>[,<occ>]]) : suffix match é¦–éƒ¨ç»“å°¾
hdr_len([<name>[,<occ>]]) : length match
hdr_reg([<name>[,<occ>]]) : regex match
hdr_sub([<name>[,<occ>]]) : substring match
ç¤ºä¾‹ï¼š</occ></name></occ></name></occ></name></occ></name></occ></name></occ></name></occ></name></occ></name></p> <div class="language-bash extra-class"><pre class="language-bash"><code>acl bad_curl hdr_sub<span class="token punctuation">(</span>User-Agent<span class="token punctuation">)</span> -i <span class="token function">curl</span> 
block <span class="token keyword">if</span> bad_curl 
</code></pre></div><h3 id="status-integer"><a href="#status-integer" class="header-anchor">#</a> status : integer</h3> <p>è¿”å›åœ¨å“åº”æŠ¥æ–‡ä¸­çš„çŠ¶æ€ç </p> <h3 id="é¢„å®šä¹‰acl"><a href="#é¢„å®šä¹‰acl" class="header-anchor">#</a> é¢„å®šä¹‰ACL</h3> <p>ACLåç§° ç­‰ä»·äº è¯´æ˜
TRUE always_true æ€»æ˜¯åŒ¹é…
FALSE always_false ä»ä¸åŒ¹é…
HTTP req_proto_http åŒ¹é…HTTPåè®®
HTTP_1.0 req_ver 1.0 åŒ¹é…HTTPåè®®1.0
HTTP_1.1 req_ver 1.1 åŒ¹é…HTTPåè®®1.1
HTTP_CONTENT hdr_val(content-length) gt 0 åŒ¹é…å·²å­˜åœ¨å†…å®¹é•¿åº¦
HTTP_URL_ABS url_reg ^[^/:]<em>ğŸ˜•/ åŒ¹é…URLç»å¯¹è·¯å¾„
HTTP_URL_SLASHurl_beg / åŒ¹é…URLç›¸å¯¹è·¯å¾„
HTTP_URL_STAR url * åŒ¹é… URL ç­‰äº &quot;</em>&quot;
LOCALHOST src 127.0.0.1/8 åŒ¹é…ä»localhostæ¥çš„è¿æ¥
METH_CONNECT method CONNECT åŒ¹é…HTTP CONNECTæ–¹æ³•
METH_GETmethod GET HEAD #match HTTP GET or HEAD method
METH_HEAD method HEAD #match HTTP HEAD method
METH_OPTIONS method OPTIONS #match HTTP OPTIONS method
METH_POST method POST #match HTTP POST method
METH_TRACE method TRACE #match HTTP TRACE method
RDP_COOKIE req_rdp_cookie_cnt gt 0 #match presence of an RDP cookie
REQ_CONTENT req_len gt 0 #match data in the request buffer
WAIT_ENDwait_end #wait for end of content analysis</p> <h3 id="aclé…ç½®"><a href="#aclé…ç½®" class="header-anchor">#</a> aclé…ç½®</h3> <h4 id="åŸºäºipçš„è®¿é—®æ§åˆ¶"><a href="#åŸºäºipçš„è®¿é—®æ§åˆ¶" class="header-anchor">#</a> åŸºäºIPçš„è®¿é—®æ§åˆ¶</h4> <p>use_backend <backend> [{if | unless} <condition>]
å½“if/unlessä¸€ä¸ªåŸºäºACLçš„æ¡ä»¶åŒ¹é…æ—¶åˆ‡æ¢æŒ‡å®šbackend</condition></backend></p> <div class="language-bash extra-class"><pre class="language-bash"><code>acl invalid_src src <span class="token number">172.16</span>.200.2 
block <span class="token keyword">if</span> invalid_src 
errorfile <span class="token number">403</span> /etc/fstab
</code></pre></div><h4 id="ä¸ƒå±‚è¯·æ±‚çš„è®¿é—®æ§åˆ¶"><a href="#ä¸ƒå±‚è¯·æ±‚çš„è®¿é—®æ§åˆ¶" class="header-anchor">#</a> ä¸ƒå±‚è¯·æ±‚çš„è®¿é—®æ§åˆ¶</h4> <p>http-request { allow | deny |add-header <name><fmt> |set-header <name><fmt> } [ { if | unless } <condition> ]</condition></fmt></name></fmt></name></p> <h4 id="å››å±‚è¯·æ±‚è®¿é—®æ§åˆ¶"><a href="#å››å±‚è¯·æ±‚è®¿é—®æ§åˆ¶" class="header-anchor">#</a> å››å±‚è¯·æ±‚è®¿é—®æ§åˆ¶</h4> <p>tcp-request connection {accept|reject} [{if | unless} <condition>]
ç¤ºä¾‹ï¼š</condition></p> <div class="language-bash extra-class"><pre class="language-bash"><code>listen <span class="token function">ssh</span> 
<span class="token builtin class-name">bind</span> :22022 
balance leastconn 
acl invalid_src src <span class="token number">172.16</span>.200.2 
tcp-request connection reject <span class="token keyword">if</span> invalid_src 
mode tcp 
server sshsrv1 <span class="token number">172.16</span>.100.6:22 check 
server sshsrv2 <span class="token number">172.16</span>.100.7:22 check backup
</code></pre></div><h4 id="åŸºäºaclçš„åŠ¨é™åˆ†ç¦»ç¤ºä¾‹"><a href="#åŸºäºaclçš„åŠ¨é™åˆ†ç¦»ç¤ºä¾‹" class="header-anchor">#</a> åŸºäºACLçš„åŠ¨é™åˆ†ç¦»ç¤ºä¾‹</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>frontend  web *:80 
    acl url_static       path_beg       -i /static /images /javascript /stylesheets 
    acl url_static       path_end       -i .jpg .gif .png .css .js .html .txt .htm 
    use_backend staticsrvs       <span class="token keyword">if</span> url_static 
    default_backend             appsrvs 
backend staticsrvs 
    balance     roundrobin 
    server      stcsrv1 <span class="token number">172.16</span>.100.6:80 check 
backend appsrvs 
    balance     roundrobin 
    server  app1 <span class="token number">172.16</span>.100.7:80 check 
    server  app1 <span class="token number">172.16</span>.100.7:8080 check 
listen stats 
    <span class="token builtin class-name">bind</span> :9091 
    stats <span class="token builtin class-name">enable</span> 
    stats auth admin:admin 
    stats admin <span class="token keyword">if</span> TRUE
<span class="token comment">#ä¸€ä¸ªACLå®šä¹‰äº†ä¸¤ä¸ªæ¡ä»¶ï¼Œå¦‚æœç”¨æˆ·çš„è¯·æ±‚æ»¡è¶³PATHä¸­å¸¦æœ‰/static /images /javascript /stylesheets è¿™äº›å­—ç¬¦çš„ï¼Œæˆ–è€…pathæ˜¯ä»¥.jpg .gif .png .css .js .html .txt .htm è¿™äº›å­—ç¬¦ç»“å°¾çš„å°±åŒ¹é…ACLå®šä¹‰</span>
<span class="token comment">#æ»¡è¶³ACLå®šä¹‰çš„è¯·æ±‚ä¸ºé™æ€è¯·æ±‚ï¼Œè¢«è°ƒåº¦åˆ°åç«¯çš„staticsrvsæœºç»„ä¸Š</span>
<span class="token comment">#ä¸æ»¡ç»„ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„è¯·æ±‚é»˜è®¤è°ƒåº¦éƒ½åç«¯åŒ…å«ä¸¤å°æœåŠ¡å™¨è½®è¯¢çš„appsrvsæœºç»„ä¸Š</span>
</code></pre></div><h3 id="æ”¯æŒhttpsåè®®"><a href="#æ”¯æŒhttpsåè®®" class="header-anchor">#</a> æ”¯æŒhttpsåè®®</h3> <p>é…ç½®HAProxyæ”¯æŒhttpsåè®®ï¼š
1 æ”¯æŒsslä¼šè¯ï¼›
bind *:443 ssl crt /PATH/TO/SOME_PEM_FILE
crt åè¯ä¹¦æ–‡ä»¶ä¸ºPEMæ ¼å¼ï¼Œä¸”åŒæ—¶åŒ…å«è¯ä¹¦å’Œæ‰€æœ‰ç§é’¥
cat demo.crt demo.key &gt; demo.pem</p> <p>2 æŠŠ80ç«¯å£çš„è¯·æ±‚é‡å‘å®š443
bind *:80
redirect scheme https if !{ ssl_fc }</p> <p>3 å‘åç«¯ä¼ é€’ç”¨æˆ·è¯·æ±‚çš„åè®®å’Œç«¯å£ï¼ˆfrontendæˆ–backendï¼‰
http_request set-header X-Forwarded-Port %[dst_port]
http_request add-header X-Forwared-Proto https if { ssl_fc }</p></flags></address></address></div> <footer class="page-edit" style="display:none;"><!----> <!----></footer> <!----> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/blog/assets/js/app.4906a91a.js" defer></script><script src="/blog/assets/js/3.f6432f4d.js" defer></script><script src="/blog/assets/js/1.8572628d.js" defer></script><script src="/blog/assets/js/40.9e07597c.js" defer></script>
  </body>
</html>
